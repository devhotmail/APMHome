<%@taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
<c:set var="ctx" value="${pageContext.request.contextPath}" />
<script type="text/html" id="ts_repairWo">
    <div class="page">
        <jsp:include page="../progressbar.html"/>
        <script src="${ctx}/resources/wechat/js/detail.js"/>

        <div class="page__bd">
            <jsp:include page="woassetinfo.html"/>
            
            <div class="repair-wo">
                <jsp:include page="faultDesc.html"/>

                <!--派工-->
<!--                <div class="weui-cells__title">预估解决时间*</div>
                <div class="weui-cells">
                    <div class="weui-cell">
                        <div class="weui-cell__bd">
                            <input id="estimatedCloseTime" name="estimatedCloseTime" class="weui-input" type="datetime-local"/>
                        </div>
                    </div>
                </div>-->

                <div class="weui-cells__title">选择</div>
                <div class="weui-cells">
                    <div class="weui-cell">
                        <div class="weui-cell__hd"><label for="assetStatus" class="weui-label">资产状态</label></div>
                        <div class="weui-cell__bd">
                            <div class="weui-cell weui-cell_select">
                                <div class="weui-cell__bd">
                                    <select class="weui-select" name="assetStatus" id="assetStatus" >
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="weui-cell">
                        <div class="weui-cell__hd"><label for="confirmedUpTime" class="weui-label">恢复时间*</label></div>
                        <div class="weui-cell__bd">
                            <input id="confirmedUpTime" name="confirmedUpTime" class="weui-input" type="datetime-local"/>
                        </div>
                    </div>
                </div>

                <!--备注-->
                <div class="weui-cells__title">备注</div>
                <div class="weui-cells">
                    <div class="weui-cell">
                        <div class="weui-cell__bd">
                            <textarea name="description" id="description" class="weui-textarea" placeholder="请输入..." rows="3"></textarea>
                        </div>
                    </div>
                </div>
                
                <div id="errorMsg" style="color:red;text-align: center;"></div>
                <div class="weui-btn-area">
                    <a class="weui-btn weui-btn_primary" href="javascript:" id="otherSubmit">维修完成</a>
                    <!--<a class="weui-btn weui-btn_primary" href="javascript:" id="returnSubmit">回退</a>-->
                </div>
                <div style="height:20px;"></div>
            </div>
            
            <div class="close-wo">
                <!--故障明细-->
                <div class="weui-cells__title">故障明细</div>
                <div class="weui-cells">
                    <div class="weui-cell">
                        <div class="weui-cell__hd"><label class="weui-label">故障类别</label></div>
                        <div class="weui-cell__bd">
                            <div class="weui-cell weui-cell_select">
                                <div class="weui-cell__bd">
                                    <select class="weui-select" name="caseType" id="caseType">

                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="weui-cell" id="patProblemslabel">
                        <div class="weui-cell__hd"><label class="weui-label">问题描述</label></div>
                        <div class="weui-cell__bd">
                            <textarea name="patProblems" id="patProblems" class="weui-textarea" rows="2" placeholder="请输入..."></textarea>
                        </div>
                    </div>
                    <div class="weui-cell" id="patActionslabel">
                        <div class="weui-cell__hd"><label class="weui-label">解决方案</label></div>
                        <div class="weui-cell__bd">
                            <textarea name="patActions" id="patActions" class="weui-textarea" rows="2" placeholder="请输入..."></textarea>
                        </div>
                    </div>
                    <div class="weui-cell" id="patTestslabel">
                        <div class="weui-cell__hd"><label class="weui-label">测试方法</label></div>
                        <div class="weui-cell__bd">
                            <textarea name="patTests" id="patTests" class="weui-textarea" placeholder="请输入..." rows="2" ></textarea>
                        </div>
                    </div>
                </div>
                <!--物料明细-->
                <div id="stepCost" >
                    <div class="weui-cells__title">物料明细</div>
                    <div class="weui-cells">
                        <a class="weui-cell weui-cell_access" href="javascript:;">
                            <div class="show-data weui-cell__bd">
                                <span style="color: #999">增加</span>
                            </div>
                            <div class="weui-cell__ft">
                            </div>
                        </a>
                        <div class="weui-cell" style="padding-top:0; padding-bottom: 0">
                            <div class="weui-cells costList" style="margin-top: 0;">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="weui-btn-area">
                    <a class="weui-btn weui-btn_primary" href="javascript:" id="submit">确认关单</a>
                </div>
                <div style="height:20px;"></div>
            </div>
            
        </div>
        
    </div>
    <script type="text/javascript">
        $(function(){
            function reloadDetail() {
                $.get(WEB_ROOT+'web/wodetail', {id: pageManager.woId}, function(ret) {
                    if (ret) {
                        app.activeProgressBar(ret.currentStepId, ret.feedbackRating);
                        //set value
                        app.setFormJsonValue(ret);
                        pageManager.workOrder = ret;
                        pageManager.currentStepId = ret.currentStepId;
                        pageManager.voice = ret.requestReasonVoice;
                        if (pageManager.voice) {
                            app.mediaShow();
                        }else{
                            $('#replay').addClass('weui-btn_plain-disabled');
                            $('#voiceBackUp').addClass('weui-btn_plain-disabled');
                        }
                        app.renderImgs();
                        
                        initdetail(ret.currentPersonId, ret.currentStepId);
                    } 
                    $('#loadingToast1').fadeOut(100);
                });
            }
            reloadDetail();
            
            function initdetail(curPerId, curStepId) {
                function repairWo(){

                    app.initSelectData('assetStatus', 'assetStatus', 1);

                    $('#otherSubmit').click(function(){
                        $('#errorMsg').html('');
                        if(!$('#confirmedUpTime').val()){
                            $('#errorMsg').html('请选择恢复时间');
                            return;
                        } 
                        pageManager.actionType = 'repair';
                        post({woId: pageManager.woId, actionType: 'repair', desc: $('#description').val(), 
                            assetStatus: $('#assetStatus').val(), confirmedUpTime : $('#confirmedUpTime').val().replace('T', ' '), currentStepId: pageManager.currentStepId});
                    });
                    $('#returnSubmit').click(function(){
                        $('#errorMsg').html('');
                        var data = colletionReturnData();
                        if(!data.desc){
                            $('#errorMsg').html('请填写回退备注');
                            return;
                        } 
                        post(data);
                    });
                }
                
                function closeWo() {
                    app.initFaultType('caseType',pageManager.workOrder.assetGroupValue);
                    $('#stepCost').on('click', '.weui-cell_access', function(){
                        pageManager.go('#ts_step_cost');
                    });
                    $('.costList').on('click', '.weui-icon-cancel', function(){
                        var $costList = $(this).parent().parent();
                        pageManager.stepCost.splice($costList.data('id'), 1);
                        $costList.remove();
                    });

                    $('#submit').click(function(){
                        var data = colletionData();
                        pageManager.actionType = '';
                        post(data);
                    });
                    function colletionData() {
                        return {woId: pageManager.woId, actionType: 'close', desc: $('#description').val(),
                                patProblems: $('#patProblems').val(), patActions: $('#patActions').val(), patTests: $('#patTests').val(),
                                caseType: $('#caseType').val(), stepDetail: pageManager.stepCost, currentStepId: pageManager.currentStepId};
                    }
                }
                
                $('.repair-wo').show();
                $('.close-wo').hide();
                repairWo();
                
                if ('${DispatchMode}' != 1) {
                    $('#returnSubmit').hide();
                }
                
                $('.wo_container').click(function(){
                    pageManager.go('#ts_wosteplist');
                    var $loadingToast = $('#loadingToast1');
                    if ($loadingToast.css('display') !== 'none') return;
                    $loadingToast.fadeIn(100);
                });
            }
            
            function post(data){
                var $loadingToast = $('#loadingToast');
                if ($loadingToast.css('display') !== 'none') return;
                $loadingToast.fadeIn(100);
                $.ajax({
                    url: WEB_ROOT+'web/workorderaction',
                    type: 'post',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function(ret) {
                        $loadingToast.fadeOut(100);
                        if (ret === 'success') {
                            if (pageManager.entryType === 'scan') {
                                $('#container').empty();
                                $('#container').append($('#ts_msg_success').html());
                            } else if (pageManager.entryType === 'wolist'){
                                pageManager.mywolist();
                                history.back();
                            } else {
                                if (pageManager.showCancel){
                                    pageManager.myreportList(1);
                                } else {
                                    pageManager.myreportList(2);
                                }
                                history.back();
                            }
                        } else {
                            var $loadingToast2 = $('#loadingToast2');
                            if ($loadingToast2.css('display') !== 'none') return;
                            $loadingToast2.fadeIn(100);
                            setTimeout(function(){$loadingToast2.fadeOut(100)}, 2000);
                        }
                    },
                    error: function(ret){
                        var $loadingToast2 = $('#loadingToast2');
                        if ($loadingToast2.css('display') !== 'none') return;
                        $loadingToast2.fadeIn(100);
                        setTimeout(function(){$loadingToast2.fadeOut(100)}, 2000);
                    }
                });
            }
            function  colletionReturnData() {
                return {woId: pageManager.woId, actionType: 'return', desc: $('#description').val()};
            }
        });
</script>

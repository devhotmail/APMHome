<script type="text/html" id="ts_step_cost">
    <div class="page">
        <form id="costForm">
            <div class="weui-cells weui-cells_form">
                <div class="weui-cell">
                    <div class="weui-cell__hd"><label class="weui-label">工时(小时)</label></div>
                    <div class="weui-cell__bd">
                        <input class="weui-input" id="manHours" name="manHours" type="text" />
                    </div>
                    <div class="weui-cell__ft">
                        <i class="weui-icon-warn"></i>
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd"><label class="weui-label">备件</label></div>
                    <div class="weui-cell__bd">
                        <input id="accessory" name="accessory" class="weui-input" type="text" maxlength="60" size="60"/>
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd"><label class="weui-label">数量</label></div>
                    <div class="weui-cell__bd">
                        <input id="accessoryQuantity" name="accessoryQuantity" class="weui-input" type="text" />
                    </div>
                    <div class="weui-cell__ft">
                        <i class="weui-icon-warn"></i>
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd"><label for="requestorName" class="weui-label">单价(元)</label></div>
                    <div class="weui-cell__bd">
                        <input id="accessoryPrice" name="accessoryPrice" class="weui-input" type="text" />
                    </div>
                    <div class="weui-cell__ft">
                        <i class="weui-icon-warn"></i>
                    </div>
                </div>
                <div class="weui-cell">
                    <div class="weui-cell__hd"><label for="requestorName" class="weui-label">其他费用(元)</label></div>
                    <div class="weui-cell__bd">
                        <input id="otherExpense" name="otherExpense" class="weui-input" type="text" />
                    </div>
                    <div class="weui-cell__ft">
                        <i class="weui-icon-warn"></i>
                    </div>
                </div>
                <div class="weui-cell">
                    <input id="cowokerUserName" name="cowokerUserName" type="hidden"/>
                    <div class="weui-cell__hd"><label for="cowokerUserId" class="weui-label">协作者</label></div>
                    <div class="weui-cell__bd">
                        <div class="weui-cell weui-cell_select">
                            <div class="weui-cell__bd">
                                <select class="weui-select" name="cowokerUserId" id="cowokerUserId" >
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        <div id="costErrorMsg" style="color:red;text-align: center;"></div>
        <div class="weui-btn-area">
            <a class="weui-btn weui-btn_primary" href="javascript:" id="costSubmit">提交</a>
            <div style="height:10px"></div>
        </div>
    </div>

    <script type="text/javascript">
        $(function(){
            app.initUserSelect('cowokerUserId', 'getcurrentperson');
            $('#cowokerUserId').change(function(){
                $('#cowokerUserName').val($('#cowokerUserId option:selected').html());
            });
            
            $('#costSubmit').click(function(){
                $('#costErrorMsg').html('');
                var array = $('#costForm').serializeArray();
                var costData = pageManager.formdata(array);
                if (costData.manHours===''&&costData.accessory===''&&costData.accessoryQuantity===''
                        &&costData.accessoryPrice===''&&costData.otherExpense===''&&costData.cowokerUserId === ''){
                    history.back();
                    return;
                }
                if ((!isNumber(costData.manHours)&&costData.manHours!=='') || (!isNumber(costData.accessoryQuantity)&&costData.accessoryQuantity!=='') 
                        || (!isNumber(costData.accessoryPrice)&&costData.accessoryPrice!=='') 
                        || (!isNumber(costData.otherExpense)&&costData.otherExpense!=='')) {
                    $('#costErrorMsg').html('工时、数量、单价和其他费用必须为数字');
                    return;
                }
                pageManager.stepCost.push(costData);
                insertCostList(costData);
                history.back();
            });

            function insertCostList(value){
                var $costList = $('.costList');
                var index = $costList.children().length;
                var tempui = '<div class="weui-cell">'+
                        '<div class="weui-cell__bd"><p>' +
                        '内部工时(小时)：'+(value.manHours?value.manHours:'0')
                        + ',  备件：'+(value.accessory?value.accessory:'无')
                        +',  数量：'+(value.accessoryQuantity?value.accessoryQuantity:'0')
                        +',  单价(元)：'+(value.accessoryPrice?value.accessoryPrice:'0')
                        +',  其他费用(元)：'+(value.otherExpense?value.otherExpense:'0')
                        +',  协作人：'+(value.cowokerUserName?value.cowokerUserName:'无') +
                        '</p></div>'+
                        '<div class="weui-cell__ft"><i class="weui-icon-cancel"></i></div></div>';
                $costList.append($(tempui).attr('data-id', index));
            }
            
            function isNumber(value) {
                var patrn = /^(-)?\d+(\.\d+)?$/;
                if (patrn.exec(value) === null || value === "") {
                    return false;
                } else {
                    return true;
                }
            }
        });
</script>
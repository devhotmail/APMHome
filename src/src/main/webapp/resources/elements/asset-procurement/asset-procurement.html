<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../behavior/context.html">
<link rel="import" href="../behavior/fetch-cached.html">
<link rel="import" href="asset-procurement-styles.html">
<link rel="stylesheet" href="../../css/dewIcons.css">
<script src="../../bower_components/d3/d3.min.js"></script>
<script src="../../bower_components/d3-transform/src/d3-transform.js"></script>
<script src="../../bower_components/urijs/src/URI.js"></script>

<dom-module id="asset-procurement">
  <template>
    <style include="asset-procurement-styles"></style>
    <div id="chart" class="chart-container">
      <svg id="svg" width$="[[width]]" height$="[[height]]"></svg>
    </div>
    <div class="related-info">
      <div class="type-select btn-group">
        <template is="dom-repeat" items="[[selectOpts]]">
          <div class$="[[computedCls(item.val, selectedOpt)]]"
            on-click="handleSelect">
            [[item.key]]
          </div>
        </template>
      </div>
      <div class="kpis">
        <h3>当前位置: [[focus.data.name]]</h3>
        当前平均使用率预测:
        <h2>[[decimal2Percent(focus.data.usage)]]</h2>
        <template is="dom-if" if="[[isArray(focus.data.suggestions)]]">
          <template is="dom-repeat" items="[[focus.data.suggestions]]">
            <div>[[item.title]]</div>
            <template is="dom-if" if="[[item.addition]]">
              <h2>[[item.addition]]</h2>
            </template>
          </template>
          <div class="divider"></div>
        </template>
        <template is="dom-if" if="[[currentKPIs.length]]">
          <template is="dom-repeat" items="[[currentKPIs]]">
            <template is="dom-if" if="[[item.conclusion]]">
              <div class$="kpi kpi-[[index]]">
                [[item.desc]]
              </div>
            </template>
            <div class="kpi-detail">
              <template is="dom-if" if="[[item.conclusion]]">
                <h2>[[item.conclusion]]台设备</h2>
              </template>
            </div>
          </template>
          <div class="divider"></div>
        </template>
      </div>
      <div class="legends">
        <h3>图示说明</h3>
        <div class="legend">
          <i class="dewicon-circle-high" style="color:#b3b3b3"></i>
          <span class="legend-tip">平均使用率预测(%)</span>
        </div>
        <div class="legend">
          <i class="dewicon-circle-full" style="color:#e26d26"></i>
          <span class="legend-tip">单台使用率预测&gt;100%</span>
        </div>
        <div class="legend">
          <i class="dewicon-circle-low" style="color:#ebda51"></i>
          <span class="legend-tip">单台使用率预测&lt;30%</span>
        </div>
        <div class="legend">球大小与设备利润预测相关</div>
      </div>
    </div>
  </template>
  <script>
    var constants = {
      waveColor: { // Color of the fill wave
        gray: 'rgb(178, 178, 178)',
        orange: 'rgb(277, 110, 21)',
        yellow: 'rgb(235, 220, 81)'
      },
      textColor: 'rgb(111, 111, 111)', // Text color
      fontScale: 0.1, // Text size relatived to circle's radius
      textTopPosition: 0.85 // Percentage of height to show text top in the asset circle
    };

    var sectionalizer = [
      {
        key: 'orange',
        loadStatus: 'high',
        desc: '使用率预测>100%',
        filter: function(n) {
          return n >= 1;
        }
      },
      {
        key: 'yellow',
        loadStatus: 'low',
        desc: '使用率预测<30%',
        filter: function(n) {
          return n <= 0.3;
        }
      }
    ];

    function commonTextAttr(selection) {
      selection.attr('text-anchor', 'middle')
      .attr('fill', constants.textColor)
      .style('user-select', 'none');
    }

    function getColorByPercent(percent) {
      var waveColor = constants.waveColor;
      if (percent >= 1) {
        return waveColor.orange;
      } else if (percent <= 0.3) {
        return waveColor.yellow;
      } else {
        return waveColor.gray;
      }
    }

    function wavePath(percent, radius) {
      if (percent > 1) {
        return 'M' + radius + ' 0'
          + 'm'+ (-radius) + ', 0'
          + 'a' + radius + ',' + radius + ' 0 1,0 ' + (radius * 2) + ',0'
          + 'a' + radius + ',' + radius + ' 0 1,0 ' + (radius * -2) + ',0'
      } else {
        var part = 1 - percent * 2
        var h = part * radius
        var w = Math.sqrt(Math.pow(radius, 2) - Math.pow(h, 2))

        var defaultWaveHeight = 0.1 // The wave height as a percentage of wave circle's radius
        var waveScaleY = d3.scaleLinear().range([0.035, 0.03]).domain([1 - defaultWaveHeight, 1])
        var waveHeight = (percent + defaultWaveHeight > 1) ? waveScaleY(percent) : defaultWaveHeight

        return 'M' + (radius - w) + ' ' + h
        + 'A' + radius + ',' + radius + ' 1' + (percent > 0.5 ? ' 1,0 ' : ' 0,0 ') + (radius + w) + ',' + h
        + 'q' + -w / 2 + ' ' + radius * waveHeight + ' ' + -w + ' 0'
        + 't' + -w + ' ' +  0
        + 'z'
      }
    }

    define('asset-procurement', [
      'behavior/context',
      'behavior/fetch-cached'
    ], function(ContextBehavior, FetchCachedBehavior) {
      Polymer({
        is: 'asset-procurement',
        properties: {
          width: Number,
          height: Number,
          data: Object,
          focus: {
            type: Object
          },
          currentKPIs: {
            type: Array,
            computed: 'getCurrentKPIs(focus)'
          },
          selectOpts: {
            type: Array,
            readOnly: true,
            value: [
              {
                key: '按设备类型',
                val: 'type',
                zh: '类型'
              },
              {
                key: '按科室',
                val: 'dept',
                zh: '科室'
              }
            ]
          },
          selectedOpt: {
            type: String
          },
          scaleK: {
            type: Number,
            value: 1
          }
        },
        behaviors: [
          Polymer.IronResizableBehavior,
          ContextBehavior,
          FetchCachedBehavior
        ],
        listeners: {
          'iron-resize': 'handleResize'
        },
        observers: [
          'redraw(width, height, data)',
          'loadData(selectedOpt)',
          'changeQuery(selectedOpt)'
        ],
        isArray: Array.isArray,
        computedCls: function(val, selectedOpt) {
          return val === selectedOpt ? 'active btn' : 'btn';
        },
        decimal2Percent: function(decimal) {
          return parseInt(decimal * 100) + '%';
        },
        changeQuery: function(selectedOpt) {
          var uri = URI('').addQuery('groupby', selectedOpt);
          var new_hash = uri.query();
          location.hash = '#' + new_hash;
        },
        getCurrentKPIs: function(focus) {
          var conclusion = focus.data.conclusion;
          if (!conclusion) return [];

          function findDesc(status) {
            var k = 0;
            while(k < sectionalizer.length) {
              if (sectionalizer[k].loadStatus === status) {
                return sectionalizer[k].desc;
              }
              k++;
            }
            return '';
          }

          return Object.keys(conclusion).map(function(n) {
            return {
              loadStatus: n,
              desc: findDesc(n),
              conclusion: conclusion[n]
            }
          });
        },
        _isChecked: function(n) {
          return n.val == this.selectedOpt;
        },
        handleSelect: function(e) {
          this.set('selectedOpt', e.model.item.val);
        },
        handleResize: function() {
          var rect = this.$.chart.getBoundingClientRect();
          this.set('width', rect.width);
          this.set('height', rect.height);
        },
        conclude: function(data) {
          // get conclusion in 1st layer
          data.items = data.items.map(function(m) {
            m.conclusion = sectionalizer.reduce(function(prev,next) {
              prev[next.loadStatus] = {};
              prev[next.loadStatus] = m.items.filter(function(i) {
                return next.filter(i.usage);
              }).length;
              return prev;
            }, {});

            return m;
          });

          // get conclusion for root
          data.conclusion = sectionalizer.reduce(function(prev, next) {
            prev[next.loadStatus] = {};
            var result = data.items.reduce(function(pr, ne) {
              pr = pr + ne.conclusion[next.loadStatus];
              return pr;
            }, 0);
            prev[next.loadStatus] = result;
            
            return prev;
          }, {});

          return data;
        },
        loadData: function(groupby) {
          var url = URI(this.resolveApiUrl('/api/dm')).query({
            groupby: groupby
          }).toString();

          return this.fetchPage(url)
          .then((function(data) {
            this.data = this.conclude(data);
          }).bind(this));

          return fetch('mock/asset-procurement.json' + '?groupby=' + groupby)
          .then(function(res) {
            return res.json();
          }).then((function(data) {
            this.data = this.conclude(data);
          }).bind(this));
        },
        redraw: function() {
          d3.select('#svg > *').remove();
          this.debounce('redraw', this.render, 500);
        },
        nodeAdaptor: function(nodes) {
          return nodes.map(function(n) {
            if (n.parent && n.parent.children.length === 1) {
              n.r = n.r * 0.8;
            }
            return n;
          })
        },
        render: function() {
          var _this = this;
          var svg = d3.select(this.$.svg);
          var margin = 20;
          var diameter = Math.min.call(null, this.width, this.height);

          var wrapperGroup = svg.append('g')
          .attr('transform', d3Transform().translate(this.width / 2, this.height / 2));

          var pack = d3.pack()
          .size([diameter - margin, diameter - margin])
          .padding(2);
          
          var root = d3.hierarchy(this.data, function(d) {
            // field `items` from api
            return d.items;
          }).sum(function(d) { return d.size; })
          .sort(function(a, b) { return b.value - a.value; })

          var nodes = pack(root).descendants();
          var focus = root;
          var view;

          this.set('focus', focus);
          // adaptor for those nodes which has a single child
          nodes = this.nodeAdaptor(nodes);

          var assetGroup = wrapperGroup
          .selectAll('g')
          .data(nodes)
          .enter().append('g')
          .attr('class', 'asset')

          assetGroup        
          .append('circle')
          .attr('r', function(d) {
            return d.r;
          })
          .attr('class', function(d) {
            return d.parent ? d.children ? 'node' : 'node node-leaf' : 'node node-root';
          })
          .attr('stroke-width', 1)
          .attr('stroke', function(d) {
            return getColorByPercent(d.data.usage);
          })
          .attr('fill', function(d) {
            return (d !== focus && d.parent !== focus) ? 'none' : 'transparent';
          })
          .on('click', function(d) {
            if (focus !== d) {
              zoom(d);
              d3.event.stopPropagation();
            }
          })
          .each(function(d) {
            var element = d3.select(this);
            element.on('mouseover', function() {
              if (d === root) return;
              var textEl = d3.select('#text-' + d.data.id);
              textEl.classed('hover', true);
            });

            element.on('mouseleave', function() {
              if (d === root) return;
              var textEl = d3.select('#text-' + d.data.id);
              textEl.classed('hover', false);
            });
          });

          var waveGroup = assetGroup.append('g')
          .attr('class', 'wave');

          waveGroup
          .append('path')
          .attr('pointer-events', 'none')
          .attr('d', function(d) {
            return wavePath(d.data.usage, d.r);
          })
          .attr('transform', function(d) {
            return 'translate(' + (-d.r) + ',' + 0 + ')';
          })
          .attr('fill', function(d) {
            return getColorByPercent(d.data.usage);
          });

          var textGroup = wrapperGroup
          .append('g')
          .attr('class', 'asset-texts')
          .selectAll('g')
          .data(nodes)
          .enter().append('g')
          .attr('class', function(d) {
            return d.parent ? d.children ? 'text' : 'text text-leaf' : 'text text-root';
          })
          .attr('id', function(d) {
            return 'text-' + d.data.id;
          })
          .each(function(d) {
            var element = d3.select(this);

            var maxR = getMaxR(d);
            // Center text
            var textCenter = element.append('g')
            .attr('class', 'text-center')
            .attr('pointer-events', 'none')
            .style('fill-opacity', function() {
              return d.parent === root ? (d.r * _this.scaleK > maxR ? 1 : 0) : 0;
            })
            .call(renderText(false));

            if (d.children) {
              // Top text
              var textTop = element
              .append('g')
              .attr('class', 'text-top')
              .attr('transform', function() {
                return 'translate(' + 0 + ',' + -d.r * constants.textTopPosition + ')';
              })
              .style('display', function(d) {
                return d === root ? 'inline' : 'none';
              })
              .style('fill-opacity', function() {
                return d === root ? 1 : 0;
              })
              .call(renderText(true));
            }
          });

          svg.on('click', function() {
            zoom(root);
          });

          zoomTo([root.x, root.y, root.r * 2 + margin]);

          this.scopeSubtree(this.$.chart, true);

          function zoom(d) {
            var focus0 = focus;
            focus = d;
            _this.set('focus', focus);

            var target = [focus.x, focus.y, focus.r * 2 + margin];

            // final scale after transition
            var k = diameter / target[2];
            _this.set('scaleK', k);

            var transition = d3.transition()
            .duration(d3.event.altKey ? 7500 : 750)
            .tween('zoom', function () {
              var i = d3.interpolateZoom(view, target);
              return function (t) {
                zoomTo(i(t));
              }
            });

            transition.selectAll('circle.node-leaf')
            .attr('fill', function(d) {
              return (d !== focus && d.parent !== focus) ? 'none' : 'transparent';
            });

            transition.selectAll('g.text-top')
            .filter(function(d) {
              return d === focus || this.style.display === 'inline';
            })
            .style('fill-opacity', function(d) {
              return (d === focus) ? 1 : 0;
            })
            .on('start', function(d) {
              if (d === focus) this.style.display = 'inline';
            })
            .on('end', function(d) {
              if (d !== focus) this.style.display = 'none';
            });

            transition.selectAll('g.text-center')
            .filter(function(d) {
              return d.parent === focus || d === focus  || this.style.display === 'inline';
            })
            .style('fill-opacity', function(d) {
              // when circle isn't big enough just hide all texts insides
              if (d.parent === focus || (d === focus && !d.children)) {
                var maxR = getMaxR(d);
                return d.r * _this.scaleK < maxR ? 0 : 1;
              } else {
                return 0;
              }
            })
            .on('start', function(d) {
              if (d.parent === focus || (d === focus && !d.children)) {
                var maxR = getMaxR(d);
                if (d.r * _this.scaleK > maxR) {
                  this.style.display = 'inline';
                } else {
                  this.style.display = 'none';
                }
              }
            })
            .on('end', function(d) {
              if (d.parent !== focus && (d !== focus || d.children)) {
                this.style.display = 'none';
              }
              var maxR = getMaxR(d);
              if (d.r * _this.scaleK < maxR) {
                this.style.display = 'none';
              }
            });
          }

          function getMaxR(d) {
            var maxX = d.data.name.length * 16;
            var maxY = 10 + 16;
            if (d.data.conclusion && d.data.conclusion.high) maxY += 16;
            return maxY;
            return Math.max.call(Math, maxX, maxY);
          }

          function zoomTo(v) {
            var k = diameter / v[2];
            view = v;

            textGroup.attr('transform', function (d) {
              return 'translate(' + (d.x - v[0]) * k + ',' + (d.y - v[1]) * k + ')';
            });

            assetGroup
            .attr('transform-origin', '50% 50%')
            .attr('transform', function (d) {
              return 'translate(' + (d.x - v[0]) * k + ',' + (d.y - v[1]) * k + ')';
            })
            .style('opacity', function(d) {
              if (d === focus) {
                if (d.children) return 0.6;
                return 1;
              } else {
                if (d.parent === focus) return 1;
                return 0.6;
              }
            })
            .selectAll('circle, g.wave')
            .attr('transform', 'scale(' + k + ')')

            // move text-top when scale changes
            textGroup.selectAll('g.text-top')
            .attr('transform', function(d) {
              return 'translate(' + 0 + ',' + -d.r * constants.textTopPosition * k + ')'
            });
          }

          function renderText(adviceIncluded) {
            return function (selection) {
              // Text for asset name display
              selection.append('text')
              // .attr('dy', '-0.35em')
              .attr('class', 'asset-name')
              .attr('font-size', 20)
              .text(function(d) {
                return d.data.name;
              })
              .call(commonTextAttr);

              // Text for usage display
              var usageTxt = selection.append('text')
              .attr('y', 20)
              .attr('font-size', 16)
              .call(commonTextAttr);

              // icon: fa-adjust
              usageTxt
              .append('tspan')
              .attr('font-family','DewIcon')
              .attr('font-size', 14)
              // .attr('fill', '#b3b3b3')
              .text('\uE002' + ' ');

              usageTxt
              .append('tspan')
              .attr('dy', '-0.2ex')
              // .attr('alignment-baseline', 'middle')
              .text(function(d) {
                return parseInt(d.data.usage * 100) + '%';
              });
              
              // Text for overload assets
              selection.each(function(d) {
                var overload = 0;
                if (Array.isArray(d.children)) {
                  overload = d.children.filter(function(n) {
                    return n.data.usage > 1
                  }).length;
                }

                if (overload > 0) {
                  var overloadTxt = d3.select(this)
                  .append('text')
                  .attr('y', 36)
                  .attr('font-size', 16)
                  .call(commonTextAttr);

                  // icon: fa-clock-o
                  overloadTxt
                  .append('tspan')
                  .attr('font-family','DewIcon')
                  .attr('font-size', 14)
                  .style('fill', '#e26d26')
                  .text('\uE001' + ' ');

                  overloadTxt
                  .append('tspan')
                  .attr('dy', '-0.2ex')
                  .text(overload + '台');
                }

                // Advice text render here
                if (adviceIncluded ||  (!adviceIncluded && d.r > 100)) {
                  if (d.data.suggestions && d.data.suggestions.length) {
                    var overloadTxt = d3.select(this)
                    .append('text')
                    .attr('y', overload ? 60 : 50)
                    .attr('font-size', 20)
                    .text(d.data.suggestions[0].title)
                    .call(commonTextAttr);
                  }
                }
              })
            }
          }
        },
        getFragObj: function(url) {
          var fragment = new URI(window.location.href).fragment();
          if (!fragment) return {};
          return fragment.split('&').reduce(function(prev, next) {
            var result = next.split('=');
            prev[result[0]] = result[1];
            return prev;
          }, {});
        },
        ready: function() {
          var hashObj = this.getFragObj(window.location.href);
          var groupby = hashObj.groupby ? hashObj.groupby : this.selectOpts[0].val;
          this.set('selectedOpt', groupby);
        }
      })
    })
  </script>
</dom-module>

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/px-dropdown/px-dropdown.html">
<link rel="import" href="../bubble-radial-chart/bubble-radial-chart.html">
<link rel="import" href="../behavior/context.html">

<dom-module id="device-status-chart">
  <template>

    <bubble-radial-chart id="chart" query-url="[[queryUrl]]" group-by="[['type']]" bubble-extend="[[_bubbleExtend]]" transform-data="[[_transformItem]]"  bubble-config="[[_bubbleConfig]]"></bubble-radial-chart>
  </template>
  <script>
    define('device-status-chart', [
      'behavior/context',
    ], function(ContextBehavior) {
      var $ = d3.select;
      var gauge_color = d3.scaleOrdinal([
        'rgba(117, 162, 234, 1)',
        'rgba(140, 211, 199, 1)',
        'rgba(204, 185, 92, 1)',
        'rgba(187, 128, 188, 1)',
        'rgba(128, 177, 211, 1)',
        'rgba(184, 188, 128, 1)',
        'rgba(157, 155, 191, 1)',
        'rgba(152, 186, 145, 1)'
      ]);

      var gauge_fills = d3.scaleOrdinal([
        'rgb(210, 219, 235)',
        'rgb(215, 229, 227)',
        'rgb(228, 224, 204)',
        'rgb(224, 213, 225)',
        'rgb(213, 222, 229)',
        'rgb(224, 225, 213)',
        'rgb(218, 218, 225)',
        'rgb(217, 224, 216)'
      ]);

      function wrap(text, width) {
        var words = text.text().split(/\s+/).reverse(),
          word,
          line = [],
          lineNumber = 0,
          lineHeight = 1.1, // ems
          y = text.attr("y") || 0,
          dy = parseFloat(text.attr("dy")) || 0,
          tspan = text.text(null).append("tspan").attr("x", 0).attr("y", y).attr("dy", dy + "em");

        while (word = words.pop()) {
          line.push(word);
          tspan.text(line.join(" "));
          if (tspan.node().getComputedTextLength() > width) {
            line.pop();
            tspan.text(line.join(" "));
            line = [word];
            tspan = text.append("tspan")
            .attr("x", 0)
            .attr("y", y)
            .attr("dy", ++lineNumber * lineHeight + dy + "em")
            .text(word);
          }
        }
      }


      // http://browserhacks.com/#hack-2f32c95ac8c021c463de0fdf685acb29
      function isIE() {
        return window.navigator.msPointerEnabled;
      }

      Polymer({
        is: 'device-status-chart',
        properties: {
          foo: {
            type: String,
            value: 'bar'
          },
          queryUrl: {
            type: String,
            computed: '_computeQueryUrl(foo)'
          },
        },
        behaviors: [
          ContextBehavior
        ],
        observers: [],
        _computeQueryUrl: function() {
          return URI('mock/device-status-data.json').toString();
//          return URI(this.resolveApiUrl('/api/device-status')).toString();
        },
        ready: function() {
          this._bubbleExtend = function(element, node) {
            element = $(element)
            var textPixels = 50;
            var radius = node.circle.r;
            var size = radius*2;

            element.append('text')
            .classed('node--text-label', 1)
            .text(node.data.name)
            .attr('text-anchor', 'middle')
            .attr('font-size', textPixels / 3 + 'px')
            .attr('fill', '#fff')
            .attr('transform', 'translate(' + [0, -.6 * radius].join(',') + ')')
            .call(wrap, size - 10);

            element.append('text')
            .classed('node--text-label', 1)
            .text(node.data.count)
            .attr('text-anchor', 'middle')
            .attr('font-size', textPixels + 'px')
            .attr('font-weight', 'bold')
            .attr('fill', '#fff')
            .attr('transform', 'translate(' + [0, .2 * radius].join(',') + ')');

            element.append('text')
            .classed('node--text-label', 1)
            .text(node.data['unit-label'])
            .attr('text-anchor', 'middle')
            .attr('font-size', textPixels/3 + 'px')
            .attr('fill', '#fff')
            .attr('transform', 'translate(' + [0, .6 * radius].join(',') + ')');
          }

          this._bubbleConfig = function(node, i, config) {
            config.height = config.width = node.size * 2;
            config.circleColor = gauge_color(i);
            config.fillColor = gauge_color(i);
            config.showWave = false;
            config.showLabel = false;
            config.waveAnimateTime = 5000;
            config.waveHeight = 0.15;
            config.waveOffset = 0.25;
            config.maxValue = +node.data.revenue_label;
            config.isRoot = node.depth;
            // gauge animation is way too expensive for IE
            config.waveRise = !isIE();
            config.waveAnimate = !isIE();
            config.valueCountUp = !isIE();
            return config;
          };
          this._transformItem = function(item) {
            item.name = item.label;
            if (!( 'revenue' in item )) {
              item.revenue = 1;
            }
            item['unit-label'] = 'Âè∞';
            return item;
          }
        }
      });
    });
  </script>
</dom-module>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>

<beans default-lazy-init="true" xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:context="http://www.springframework.org/schema/context"
       xmlns:util="http://www.springframework.org/schema/util" xmlns:security="http://www.springframework.org/schema/security" xmlns:tx="http://www.springframework.org/schema/tx"
       xmlns:mvc="http://www.springframework.org/schema/mvc" xmlns:p="http://www.springframework.org/schema/p" xmlns:task="http://www.springframework.org/schema/task" xmlns:aop="http://www.springframework.org/schema/aop"
       xmlns:jpa="http://www.springframework.org/schema/data/jpa"
       xsi:schemaLocation="
			http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
			http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.0.xsd
			http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-3.0.xsd
			http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-3.1.xsd
			http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-3.0.xsd
			http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc-3.0.xsd
			http://www.springframework.org/schema/task http://www.springframework.org/schema/task/spring-task-3.0.xsd
			http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-3.0.xsd
            http://www.springframework.org/schema/data/jpa http://www.springframework.org/schema/data/jpa/spring-jpa.xsd">
    <description><![CDATA[
		Main entry point for spring configuration
	]]></description>

    <!-- context -->
    <context:component-scan base-package="webapp.framework,com.ge.apm" name-generator="webapp.framework.util.WithoutTrailingImplBeanNameGenerator">
        <!-- Let springmvc context scan the web package -->
        <context:exclude-filter type="regex" expression="webapp/framework/web/.*,com/ge/apm/web/.*"/>
    </context:component-scan>
    <context:property-placeholder location="classpath*:database.properties,classpath*:hibernate.properties,classpath*:risPacs.properties"/>

    <!-- security -->
    <security:authentication-manager>
        <security:authentication-provider user-service-ref="userDetailsService"/>
    </security:authentication-manager>
    <security:global-method-security jsr250-annotations="enabled"/>

    <!-- spring transaction -->
    <tx:annotation-driven/>

    <!-- datasource -->
    <bean id="risDataSource" class="org.apache.commons.dbcp.BasicDataSource"
              destroy-method="close"
              lazy-init="true"
              p:defaultAutoCommit="true"
              p:driverClassName="${jdbc.driver}"
              p:url="${jdbc.url}"
              p:username="${jdbc.user}"
              p:password="${jdbc.password}"
              p:initialSize="5"
              p:maxActive="100"
              p:maxIdle="30"
              p:maxWait="1000"
              p:poolPreparedStatements="true"
              p:removeAbandoned="true"
              p:removeAbandonedTimeout="60"
              p:testOnBorrow="true" p:testOnReturn="true" p:testWhileIdle="true"
              p:validationQuery="select 1" p:timeBetweenEvictionRunsMillis="1000" p:minEvictableIdleTimeMillis="1000"/>

    <!-- jmx -->
    <context:mbean-server/>
    <context:mbean-export registration="ignoreExisting" default-domain="ri"/>

    <!-- jdbc template -->
    <bean id="jdbcTemplate"
              class="org.springframework.jdbc.core.JdbcTemplate" abstract="false" lazy-init="false" autowire="default">
        <property name="dataSource">
            <ref bean="risDataSource"/>
        </property>
    </bean>

    <!-- jpa -->
    <jpa:repositories base-package="webapp.framework.dao,com.ge.apm.dao" factory-class="webapp.framework.dao.GenericRepositoryFactoryBean" transaction-manager-ref="transactionManager" entity-manager-factory-ref="entityManagerFactory"/>

    <bean id="transactionManager" class="org.springframework.orm.jpa.JpaTransactionManager"
              p:entityManagerFactory-ref="entityManagerFactory">
        <description>Please read http://www.springframework.org/docs/reference/transaction.html</description>
    </bean>
    <bean id="hibernateJpaVendorAdapter" class="org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter">
        <description>Allow spring to configure hibernate specific settings</description>
    </bean>
    <bean id="entityManagerFactory" class="org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean"
              p:dataSource-ref="risDataSource"
              p:persistenceUnitName="risSiPU"
              p:jpaVendorAdapter-ref="hibernateJpaVendorAdapter"
              p:jpaProperties="classpath:hibernate.properties">
        <description>NA</description>
    </bean>
    <util:property-path id="sessionFactory" path="entityManagerFactory.sessionFactory"/>

    <!-- bean validation -->
    <bean id="validator" class="org.springframework.validation.beanvalidation.LocalValidatorFactoryBean"
              p:validationMessageSource-ref="messageSource">
        <description>NA</description>
    </bean>

    <!-- localization -->
    <bean id="messageSource" class="org.springframework.context.support.ReloadableResourceBundleMessageSource"
              p:fallbackToSystemLocale="false"
              p:useCodeAsDefaultMessage="true"
              p:defaultEncoding="UTF-8">
        <description>Base message source to handle internationalization</description>
        <property name="basenames">
            <list>
             <value>classpath:config.properties</value>
<!--
                <value>classpath:localization/application</value>
                <value>classpath:localization/messages</value>
                <value>classpath:localization/webReport</value>
                  <value>classpath:config/config</value>
                <value>classpath:Bundle</value>
                <value>classpath:org/springframework/security/messages</value>
                <value>classpath:ValidationMessages</value>
                <value>classpath:javax/faces/Messages</value>
                <value>classpath:org/hibernate/validator/ValidationMessages</value>
-->
            </list>
        </property>
    </bean>
</beans>
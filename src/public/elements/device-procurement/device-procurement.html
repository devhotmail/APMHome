<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../behavior/context.html">
<link rel="import" href="../behavior/fetch-cached.html">
<link rel="import" href="../zoom-pack-chart/zoom-pack-chart.html">
<link rel="import" href="device-procurement-styles.html">
<link rel="stylesheet" href="../../css/dewIcons.css">
<link rel="import" href="../../uri.html">

<dom-module id="device-procurement">
  <template>
    <style include="device-procurement-styles"></style>
    <div class="chart-wrapper">
      <zoom-pack-chart chart-data="[[data]]"></zoom-pack-chart>
    </div>
    <div class="sidebar">
      <div class="type-select btn-group">
        <template is="dom-repeat" items="[[selectOpts]]">
          <div class$="[[computedCls(item.val, selectedOpt)]]"
            on-click="handleSelect">
            [[item.key]]
          </div>
        </template>
      </div>
      <div class="tabs">
        <div style="text-align: center;">
          <div class="tabs-header">
            <div class="sliding" style$="left: [[slidingLeft]]"></div>
            <ul>
              <template is="dom-repeat" items="[[tabList]]">
                <li
                  class$="[[calcTabCls(item.val, activeTab)]]"
                  on-tap="handleTabTap">
                  [[item.key]]
                </li>
              </template>
            </ul>
          </div>
        </div>
        <div class="tabs-content">
          <template is="dom-if" if="[[isEqual(activeTab, 0)]]">
            <div class="related-info">
              <div class="kpis">
                <h3>当前位置: [[focus.data.name]]</h3>
                当前平均使用率预测:
                <h2>[[decimal2Percent(focus.data.usage)]]</h2>
                <template is="dom-if" if="[[isArray(focus.data.suggestions)]]">
                  <template is="dom-repeat" items="[[focus.data.suggestions]]">
                    <template is="dom-if" if="[[item.title]]">
                      <div>[[item.title]]</div>
                    </template>
                    <template is="dom-if" if="[[item.addition]]">
                      <h2>[[item.addition]]</h2>
                    </template>
                  </template>
                  <div class="divider"></div>
                </template>
                <template is="dom-if" if="[[currentKPIs.length]]">
                  <template is="dom-repeat" items="[[currentKPIs]]">
                    <template is="dom-if" if="[[item.conclusion]]">
                      <div class$="kpi kpi-[[index]]">
                        [[item.desc]]
                      </div>
                    </template>
                    <div class="kpi-detail">
                      <template is="dom-if" if="[[item.conclusion]]">
                        <h2>[[item.conclusion]]台设备</h2>
                      </template>
                    </div>
                  </template>
                </template>
              </div>
              <div class="divider"></div>
              <div class="legends">
                <h3>图示说明</h3>
                <div class="legend">
                  <i class="dewicon-circle-high" style="color:#b3b3b3"></i>
                  <span class="legend-tip">平均使用率预测(%)</span>
                </div>
                <div class="legend">
                  <i class="dewicon-circle-full" style="color:#e26d26"></i>
                  <span class="legend-tip">单台使用率预测&gt;100%</span>
                </div>
                <div class="legend">
                  <i class="dewicon-circle-low" style="color:#ebda51"></i>
                  <span class="legend-tip">单台使用率预测&lt;30%</span>
                </div>
                <div class="legend">球大小与设备利润预测相关</div>
              </div>
            </div>
          </template>
          <template is="dom-if" if="[[isEqual(activeTab, 1)]]">
            222
          </template>
        </div>
      </div>
    </div>
  </template>
  <script>
    var sectionalizer = [
      {
        key: 'orange',
        loadStatus: 'high',
        desc: '使用率预测>100%',
        filter: function(n) {
          return n >= 1;
        }
      },
      {
        key: 'yellow',
        loadStatus: 'low',
        desc: '使用率预测<30%',
        filter: function(n) {
          return n <= 0.3;
        }
      }
    ];

    define('device-procurement', [
      'behavior/context',
      'behavior/fetch-cached'
    ], function(ContextBehavior, FetchCachedBehavior) {
      Polymer({
        is: 'device-procurement',
        properties: {
          data: Object,
          focus: {
            type: Object
          },
          currentKPIs: {
            type: Array,
            computed: 'getCurrentKPIs(focus)'
          },
          tabList: {
            type: Array,
            readOnly: true,
            value: [
              {
                key: '系统自动',
                val: 0
              },
              {
                key: '手动调节',
                val: 1
              }
            ]
          },
          activeTab: {
            type: Number,
            value: 0
          },
          slidingLeft: {
            type: String,
            computed: 'calcSlidingLeft(activeTab)'
          },
          selectOpts: {
            type: Array,
            readOnly: true,
            value: [
              {
                key: '按设备类型',
                val: 'type',
                zh: '类型'
              },
              {
                key: '按科室',
                val: 'dept',
                zh: '科室'
              }
            ]
          },
          selectedOpt: {
            type: String
          },
          scaleK: {
            type: Number,
            value: 1
          }
        },
        behaviors: [
          ContextBehavior,
          FetchCachedBehavior
        ],
        observers: [
          'loadData(selectedOpt)',
          'changeQuery(selectedOpt)',
        ],
        isArray: Array.isArray,
        isEqual: function(a, b) {
          return a === b;
        },
        handleTabTap: function(e) {
          this.set('activeTab', e.model.item.val);
        },
        calcTabCls: function(val, activeTab){
          return val === activeTab ? 'active' : ''
        },
        calcSlidingLeft: function(activeTab) {
          return activeTab * 90 + 'px';
        },
        computedCls: function(val, selectedOpt) {
          return val === selectedOpt ? 'active btn' : 'btn';
        },
        decimal2Percent: function(decimal) {
          return parseInt(decimal * 100) + '%';
        },
        changeQuery: function(selectedOpt) {
          var uri = URI('').addQuery('groupby', selectedOpt);
          var new_hash = uri.query();
          location.hash = '#' + new_hash;
        },
        getCurrentKPIs: function(focus) {
          var conclusion = focus.data.conclusion;
          if (!conclusion) return [];

          function findDesc(status) {
            var k = 0;
            while(k < sectionalizer.length) {
              if (sectionalizer[k].loadStatus === status) {
                return sectionalizer[k].desc;
              }
              k++;
            }
            return '';
          }

          return Object.keys(conclusion).map(function(n) {
            return {
              loadStatus: n,
              desc: findDesc(n),
              conclusion: conclusion[n]
            }
          });
        },
        _isChecked: function(n) {
          return n.val == this.selectedOpt;
        },
        handleSelect: function(e) {
          this.set('selectedOpt', e.model.item.val);
        },
        dataConverter: function(data) {
          // get conclusion in 1st layer
          data.items = data.items.map(function(m) {
            m.conclusion = sectionalizer.reduce(function(prev,next) {
              prev[next.loadStatus] = {};
              prev[next.loadStatus] = m.items.filter(function(i) {
                return next.filter(i.usage);
              }).length;
              return prev;
            }, {});

            return m;
          });

          // get conclusion for root
          data.conclusion = sectionalizer.reduce(function(prev, next) {
            prev[next.loadStatus] = {};
            var result = data.items.reduce(function(pr, ne) {
              pr = pr + ne.conclusion[next.loadStatus];
              return pr;
            }, 0);
            prev[next.loadStatus] = result;
            
            return prev;
          }, {});

          return data;
        },
        loadData: function(groupby) {
          var url = URI(this.resolveApiUrl('/api/dm')).query({
            groupby: groupby
          }).toString();

          return fetch('mock/asset-procurement.json' + '?groupby=' + groupby)
          .then(res => res.json())
          // return this.fetchPage(url)
          .then((function(data) {
            this.data = this.dataConverter(data);
          }).bind(this));
        },
        getFragObj: function(url) {
          var fragment = new URI(window.location.href).fragment();
          if (!fragment) return {};
          return fragment.split('&').reduce(function(prev, next) {
            var result = next.split('=');
            prev[result[0]] = result[1];
            return prev;
          }, {});
        },
        ready: function() {
          var hashObj = this.getFragObj(window.location.href);
          var groupby = hashObj.groupby ? hashObj.groupby : this.selectOpts[0].val;
          this.set('selectedOpt', groupby);
        }
      })
    })
  </script>
</dom-module>

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../behavior/context.html">
<link rel="import" href="../behavior/fetch-cached.html">
<link rel="import" href="../responsive-container/responsive-container.html">
<link rel="import" href="../zoom-pack-chart/zoom-pack-chart.html">
<link rel="import" href="../editable-block/editable-block.html">
<link rel="import" href="device-procurement-styles.html">
<link rel="stylesheet" href="../../css/dewIcons.css">
<link rel="import" href="../../uri.html">
<link rel="import" href="../d3/d3.html">

<dom-module id="device-procurement">
  <template>
    <style include="device-procurement-styles"></style>
    <div class="chart-wrapper">
      <responsive-container width="{{width}}" height="{{height}}">
        <template is="dom-if" if="[[isEqual(activeTab, 0)]]">
          <!--system recommended result-->
          <zoom-pack-chart
            width="{{width}}"
            height="{{height}}"
            child-key="items"
            size-key="revenue_predict_raw"
            chart-data="[[systemData]]"></zoom-pack-chart>
        </template>
        <template is="dom-if" if="[[isEqual(activeTab, 1)]]">
          <!--user manually configed result-->
          <zoom-pack-chart
            width="{{width}}"
            height="{{height}}"          
            child-key="items"
            size-key="revenue_predict_raw"
            chart-data="[[manualData]]"></zoom-pack-chart>
        </template>
      </responsive-container>
    </div>
    <div class="sidebar">
      <div class="type-select btn-group">
        <template is="dom-repeat" items="[[typeOpts]]">
          <div class$="[[calcTabCls(item.val, selectedType)]]"
            on-click="handleSelect">
            [[item.key]]
          </div>
        </template>
      </div>
      <div class="tabs">
        <div style="text-align: center;">
          <div class="tabs-header">
            <div class="sliding" style$="left: [[slidingLeft]]"></div>
            <ul>
              <template is="dom-repeat" items="[[tabList]]">
                <li
                  class$="[[calcTypeCls(item.val, activeTab)]]"
                  on-tap="handleTabTap">
                  [[item.key]]
                </li>
              </template>
            </ul>
          </div>
        </div>
        <div class="tabs-content">
          <template is="dom-if" if="[[isEqual(activeTab, 0)]]">
            <div class="related-info">
              <div class="kpis">
                <div class="title u-mt u-mb">当前位置: [[focus.data.name]]</div>
                <div class="u-mb--">未来12个月收益预测([[focus.data.revenue_unit]]元)</div>
                <div class="text-muted u-mb--">过去两年的历史数据</div>
                <div class="flex flex--middle revenue-tip muted">
                  <div class="revenue-label">2014.4</div>
                  <div class="flex__item u-ml-- u-mr--">
                    <div class="progress-bar" style="width: 90%"></div>
                  </div>
                  <div class="revenue-num">[[parseInt(focus.data.revenue_year_before_last)]]</div>
                </div>
                <div class="flex flex--middle revenue-tip muted">
                  <div class="revenue-label">2015.4</div>
                  <div class="flex__item u-ml-- u-mr--">
                    <div class="progress-bar" style="width: 90%"></div>
                  </div>
                  <div class="revenue-num">[[parseInt(focus.data.revenue_last_year)]]</div>
                </div>
                <div class="text-muted u-mt-- u-mb--">未来12个月</div>
                <div class="flex flex--middle revenue-tip">
                  <div class="revenue-label">预测</div>
                  <div class="flex__item u-ml-- u-mr--">
                    <div class="progress-bar" style="width: 90%"></div>
                  </div>
                  <div class="revenue-num">
                    [[parseInt(focus.data.revenue_predict)]] +[[decimal2Percent(focus.data.revenue_increase)]]
                  </div>
                </div>
                <div class="flex flex--middle revenue-tip">
                  <div class="revenue-label">采取建议</div>
                  <div class="flex__item u-ml-- u-mr--">
                    <div class="progress-bar" style="width: 90%"></div>
                  </div>
                  <div class="revenue-num">
                    [[parseInt(focus.data.revenue_predict_sug)]] +[[decimal2Percent(focus.data.revenue_increase_sug)]]
                  </div>
                </div>
                <div class="divider"></div>
                当前平均使用率预测:
                <div class="title u-mt- u-mb-">[[decimal2Percent(focus.data.usage)]]</div>
                <template is="dom-if" if="[[isArray(focus.data.suggestions)]]">
                  <template is="dom-repeat" items="[[focus.data.suggestions]]">
                    <template is="dom-if" if="[[item.title]]">
                      <div>[[item.title]]</div>
                    </template>
                    <template is="dom-if" if="[[item.addition]]">
                      <div class="title u-mt- u-mb-">[[item.addition]]</div>
                    </template>
                  </template>
                  <div class="divider"></div>
                </template>
                <template is="dom-if" if="[[isOr(currentKPIs.0.num, currentKPIs.1.num)]]">
                  <template is="dom-repeat" items="[[currentKPIs]]">
                    <template is="dom-if" if="[[item.num]]">
                      <div class$="kpi kpi-[[index]]">[[item.desc]]</div>
                    </template>
                    <div class="kpi-detail">
                      <template is="dom-if" if="[[item.num]]">
                        <div class="title u-mt- u-mb-">[[item.num]]台设备</div>
                      </template>
                    </div>
                  </template>
                  <div class="divider"></div>
                </template>
              </div>
              <div class="legends">
                <div class="title u-mt- u-mb-">图示说明</div>
                <div class="legend">
                  <i class="dewicon-circle-high" style="color:#b3b3b3"></i>
                  <span class="legend-tip">平均使用率预测(%)</span>
                </div>
                <div class="legend">
                  <i class="dewicon-circle-full" style="color:#e26d26"></i>
                  <span class="legend-tip">单台使用率预测&gt;100%</span>
                </div>
                <div class="legend">
                  <i class="dewicon-circle-low" style="color:#ebda51"></i>
                  <span class="legend-tip">单台使用率预测&lt;30%</span>
                </div>
                <div class="legend">球大小与设备利润预测相关</div>
              </div>
            </div>
          </template>
          <template is="dom-if" if="[[isEqual(activeTab, 1)]]">
            <div class="title u-mt u-mb">未来12个月收益预测</div>
            <div class="text-muted u-mb-">基于系统自动建议值进行手工调节</div>
            <div class="config-list-wrapper">
              <div
                class$="[[calcConfiglistCls(configListTwo.length)]]"
                style$="[[calcConfigHeight(configListOne.length)]]">
                <template
                  id="configList"
                  is="dom-repeat"
                  items="[[configListOne]]">
                  <div
                    class$="[[calcConfigItemCls(selectedConfigIndex, index)]]"
                    on-tap="handleConfigTap">
                    <div class="item-name">[[item.name]]</div>
                    <template is="dom-if" if="[[item.isUnknown]]">
                      <div>待计算</div>
                    </template>
                    <template is="dom-if" if="[[!item.isUnknown]]">
                      <editable-block
                        data-index$="[[index]]"
                        value="[[item.increase]]"
                        on-changed="handleConfigChange"></editable-block>
                      <span>%</span>
                    </template>
                  </div>
                </template>
                <array-selector
                  id="configSelector"
                  items="[[configListOne]]"
                  selected="{{selectedConfigIndex}}"></array-selector>
              </div>
              <template is="dom-if" if="[[configListTwo.length]]">
                <div class="config-list" style$="[[calcConfigHeight(configListTwo.length)]]">
                  <template
                    id="subConfigList"
                    is="dom-repeat"
                    items="[[configListTwo]]">
                    <div
                      class$="[[calcConfigItemCls(selectedSubConfigIndex, index)]]"
                      on-tap="handleSubConfigTap">
                      <div class="item-name">[[item.name]]</div>
                      <editable-block
                        data-index$="[[index]]"
                        value="[[item.increase]]"
                        on-changed="handleSubConfigChange"></editable-block>
                      <span>%</span>
                    </div>
                  </template>
                  <array-selector
                    id="subConfigSelector"
                    items="[[configListTwo]]"
                    selected="{{selectedSubConfigIndex}}"></array-selector>
                </div>
              </template>
            </div>
            <div class="btn-group u-mt" id="btn">
              <div class="btn active" on-tap="handleSubmit">
                确认建议
              </div>
            </div>
            <div class="divider"></div>
            <div class="text-muted u-mb--">新建议产生的全部设备收益预测([[focus.data.revenue_unit]])</div>
            <div class="flex flex--middle revenue-tip">
              <div class="revenue-label">采取建议</div>
              <div class="flex__item u-ml-- u-mr--">
                <div class="progress-bar" style="width: 90%"></div>
              </div>
              <div class="revenue-num">
                [[parseInt(focus.data.revenue_predict_sug)]] +[[decimal2Percent(focus.data.revenue_increase_sug)]]
              </div>
            </div>
            <div class="divider"></div>
            <div>
              <div class="title u-mt u-mb">当前位置: [[focus.data.name]]</div>
              当前平均使用率预测:
              <div class="title u-mt- u-mb-">[[decimal2Percent(focus.data.usage)]]</div>
              <template is="dom-if" if="[[isArray(focus.data.suggestions)]]">
                <template is="dom-repeat" items="[[focus.data.suggestions]]">
                  <template is="dom-if" if="[[item.title]]">
                    <div>[[item.title]]</div>
                  </template>
                  <template is="dom-if" if="[[item.addition]]">
                    <div class="title u-mt- u-mb-">[[item.addition]]</div>
                  </template>
                </template>
              </template>
            </div>
          </template>
        </div>
      </div>
    </div>
  </template>
  <script>
    function uniqueId() {
      return Math.random().toString(36).substr(2, 9);
    }

    var sectionalizer = [
      {
        key: 'orange',
        status: 'high',
        desc: '使用率预测>100%',
        filter: function(n) {
          return n >= 1;
        }
      },
      {
        key: 'yellow',
        status: 'low',
        desc: '使用率预测<30%',
        filter: function(n) {
          return n <= 0.3;
        }
      }
    ];

    define('device-procurement', [
      'behavior/context',
      'behavior/fetch-cached'
    ], function(ContextBehavior, FetchCachedBehavior) {
      Polymer({
        is: 'device-procurement',
        properties: {
          systemData: Object,
          manualData: Object,
          focus: Object,
          selectedConfigIndex: {
            type: Number,
            value: 0
          },
          selectedSubConfigIndex: {
            type: Number,
            value: 0
          },
          selectedConfigItem: {
            type: Object,
            computed: 'getSelectedConfigItem(configListOne, selectedConfigIndex)'
          },
          configList: Array,
          configListOne: {
            type: Array,
            computed: 'getConfigListOne(configList)'
          },
          configListTwo: {
            type: Array,
            computed: 'getConfigListTwo(configList, selectedConfigItem)'
          },
          currentKPIs: {
            type: Array,
            computed: 'getCurrentKPIs(focus)'
          },
          tabList: {
            type: Array,
            readOnly: true,
            value: [
              {
                key: '系统自动',
                val: 0
              },
              {
                key: '手动调节',
                val: 1
              }
            ]
          },
          activeTab: {
            type: Number,
            value: 1
          },
          slidingLeft: {
            type: String,
            computed: 'calcSlidingLeft(activeTab)'
          },
          typeOpts: {
            type: Array,
            readOnly: true,
            value: [
              {
                key: '按设备类型',
                val: 'type',
                zh: '类型'
              },
              {
                key: '按科室',
                val: 'dept',
                zh: '科室'
              }
            ]
          },
          selectedType: {
            type: String
          }
        },
        behaviors: [
          ContextBehavior,
          FetchCachedBehavior
        ],
        observers: [
          'loadData(selectedType)',
          'changeQuery(selectedType)',
          'resetSubSelectedConfigIndex(selectedConfigIndex)'
        ],
        getConfigListOne: function(configList) {
          return configList.filter(function(n) {
            return n.depth === 1;
          });
        },
        getConfigListTwo: function(configList, selectedConfigItem) {
          // dont show items which in the last layer
          var root = this.configList[0];
          if (root.depth !== 0 || root.height === 2) return [];
          return configList.filter(function(n) {
            return n.depth === 2 && n.parent.uid === selectedConfigItem.uid;
          });
        },
        resetSubSelectedConfigIndex: function(selectedConfigIndex) {
          // reset subSelectedConfig index when selectedConfigIndex changes
          this.selectedSubConfigIndex = 0;
        },
        getSelectedConfigItem: function(array, index) {
          if (Array.isArray(array) && Number.isFinite(index)) {
            return array[index];
          }
        },
        /**
         * callback for dom interactive events
        */
        handleTabTap: function(e) {
          this.set('activeTab', e.model.item.val);
        },
        handleSelect: function(e) {
          this.set('selectedType', e.model.item.val);
        },
        // trigger `selected` in array-selector
        handleConfigTap: function(e) {
          var root = Polymer.dom(this.root);
          var index = root.querySelector('#configList').indexForElement(e.target);
          root.querySelector('#configSelector').select(index);
          // set child config index as zero
          this.selectedSubConfigIndex = 0;
        },
        handleSubConfigTap: function(e) {
          var root = Polymer.dom(this.root);
          var index = root.querySelector('#subConfigList').indexForElement(e.target);
          root.querySelector('#subConfigSelector').select(index);
        },
        handleConfigChange: function(e) {
          // get value and index
          var value = e.detail.value;
          var index = e.target.getAttribute('data-index'); // this.selectedConfigIndex

          if (index > -1) {
            // update value for current target
            var cursor = this.configListOne[index].uid;
            var target = this.configList.filter(function(n) {
              return n.uid === cursor;
            })[0];
            target.increase = value;

            // update children
            var children = target.children;
            if (children && children.length) {
              var childUidList = children.map(function(n) {
                return n.uid;
              });
              var configList = this.configList.map(function(config) {
                if (~childUidList.indexOf(config.uid)) config.increase = value;
                return config;
              });
            }
            // force dirty check and keep selected index
            var _tmp = this.selectedConfigIndex;
            this.configList = this.deepClone(configList);
            this.selectedConfigIndex = _tmp;
          }
        },
        handleSubConfigChange: function(e) {
          // get value and index
          var value = e.detail.value;
          var index = e.target.getAttribute('data-index'); // this.selectedConfigIndex

          if (index > -1) {
            // update value for current target
            var cursor = this.configListTwo[index].uid;
            var target = this.configList.filter(function(n) {
              return n.uid === cursor;
            })[0];
            target.increase = value;

            // update parent
            var parentUid = target.parent.uid;
            var parent = this.configList.filter(function(n) {
              return n.uid === parentUid;
            })[0];
            if (parent) parent.isUnknown = true;

            // force dirty check and keep selected index
            var _tmp1 = this.selectedConfigIndex;
            var _tmp2 = this.selectedSubConfigIndex;
            this.configList = this.deepClone(this.configList);
            this.selectedConfigIndex = _tmp1;
            this.selectedSubConfigIndex = _tmp2;
          }
        },
        handleSubmit: function(e) {
          var root = this.configList[0];
          if (root.depth === 0) {
            var tmp = this.configList.filter(function(n) {
              return n.depth === root.height - 1;
            }).map(function(n) {
              return (n.children && n.children.length) 
                ? n.children.map(function(child) {
                  return {
                    id: child.id,
                    increase: n.increase / 100 // for the display usage # 1
                  }
                })
                : [];
            });

            var payload = [].concat.apply([], tmp);
            console.log(payload)
          }
        },
        /**
         * deep clone for plain object
        */
        deepClone: function(plainObj) {
          return JSON.parse(JSON.stringify(plainObj));
        },
        /**
         * functions which calculate className for dom styles usage
        */
        calcConfiglistCls: function(length) {
          return length > 0 ? 'config-list with-arrow' : 'config-list';
        },
        calcConfigHeight: function(length) {
          return length < 10 ? 'height: auto' : '';
        },
        calcConfigItemCls: function(a, b) {
          var clsBase = 'config-item';
          return a === b ? clsBase + ' ' + 'active' : clsBase;
        },
        calcTypeCls: function(val, activeTab){
          return val === activeTab ? 'active' : ''
        },
        calcSlidingLeft: function(activeTab) {
          return activeTab * 90 + 'px';
        },
        calcTabCls: function(val, selectedType) {
          return val === selectedType ? 'active btn' : 'btn';
        },
        /**
         * functions which convert string for dom text display
        */
        decimal2Percent: function(decimal) {
          return parseInt(decimal * 100) + '%';
        },
        parseInt: parseInt,
        isArray: Array.isArray,
        isEqual: function(a, b) {
          return a === b;
        },
        isOr: function(a, b) {
          return a || b;
        },
        /**
         * functions which do data convert jobs
        */
        getCurrentKPIs: function(focus) {
          var descList = [
            '使用率预测<30%',
            '使用率预测>100%',
          ];

          var usageSum = focus.data.usage_sum;
          if (usageSum && usageSum.length) {
            return usageSum.map(function(n, i) {
              return {
                desc: descList[i],
                num: n
              }
            });
          } else return [];
        },
        dataConverter: function(data) {
          function patchUid(obj) {
            obj.uid = uniqueId();
            if (obj.items && Array.isArray(obj.items)) {
              obj.items = obj.items.map(n => {
                patchUid(n)
                return n
              })
            }
            return obj;
          }

          data = patchUid(data);

          return data;
        },
        getInitConfig: function(data) {
          var root = d3.hierarchy(data, function(d) {
            return d.items
          });

          var tree = d3.tree();

          var nodes = tree(root).descendants();
          return nodes.map(function(n) {
            return {
              parent: n.parent ? {
                id: n.parent.data.id,
                uid: n.parent.data.uid
              }: null,
              children: n.children ? n.children.map(function(child) {
                return {
                  uid: child.data.uid,
                  id: child.data.id
                };
              }) : null,
              depth: n.depth,
              height: n.height,
              id: n.data.id,
              uid: n.data.uid,
              name: n.data.name,
              increase: parseInt(n.data.revenue_increase * 100) // for the display usage # 1
            }
          });
        },
        /**
         * functions which deal with url hash
        */
        changeQuery: function(selectedType) {
          var uri = URI('').addQuery('groupby', selectedType);
          var new_hash = uri.query();
          location.hash = '#' + new_hash;
        },
        getFragObj: function(url) {
          var fragment = new URI(window.location.href).fragment();
          if (!fragment) return {};
          return fragment.split('&').reduce(function(prev, next) {
            var result = next.split('=');
            prev[result[0]] = result[1];
            return prev;
          }, {});
        },
        /**
         * load data from restful api
        */
        loadData: function(groupby) {
          var url = URI(this.resolveApiUrl('/api/dm')).query({
            groupby: groupby
          }).toString();

          return fetch('mock/asset-procurement-' + groupby + '.json')
          .then(res => res.json())
          // return this.fetchPage(url)
          .then((function(data) {
            var data = this.dataConverter(data);
            // set system data
            this.systemData = this.deepClone(data);
            this.systemData.isSystem = true;
            // set manual data
            this.manualData = this.deepClone(data);
            this.manualData.isManual = true;
            // set config list
            this.configList = this.getInitConfig(data);
            // set initial selected config index after configList
            this.selectedConfigIndex = 0;
          }).bind(this));
        },
        ready: function() {
          var hashObj = this.getFragObj(window.location.href);
          var groupby = hashObj.groupby ? hashObj.groupby : this.typeOpts[0].val;
          this.set('selectedType', groupby);
        }
      })
    })
  </script>
</dom-module>

<link rel="import" href="../../bower_components/polymer/polymer.html"/>

<link rel="import" href="editable-block-styles.html">

<dom-module id="editable-block">
  <template>
    <style include="editable-block-styles"></style>
    <div class="block" id="counter">
      <template is="dom-if" if="{{showInput}}">
        <input id="userInput"
          type="text"
          value="{{inputVal::input}}"
          on-keydown="handleInputKeydown">
      </template>
      <template is="dom-if" if="{{!showInput}}">
        <span class="current"
          on-click="handleShowInput">{{value}}</span>
      </template>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'editable-block',
    properties: {
      value: {
        type: Number,
        notify: true
      },
      inputVal: Number,
      showInput: {
        type: Boolean,
        value: false
      }
    },
    handleShowInput: function () {
      this.inputVal = this.value;
      this.showInput = true;
      this.async((function() {
        this.$.counter.querySelector('#userInput').focus();
      }).bind(this));
    },
    isNumeric: function(n) {
      return !isNaN(parseFloat(n)) && isFinite(n);
    },
    updateValue: function () {
      const regex = /^-{0,1}\d*\.?\d+$/;
      if (regex.test(this.inputVal)) {
        var newValue = parseFloat(this.inputVal);
        this.fire('changed', {
          value: newValue,
          oldValue: this.value
        });
        this.value = newValue;
      }
      this.showInput = false;
    },
    handleInputKeydown: function (e) {
      var keycode = event.which || event.keyCode;
      if (keycode === 13) this.updateValue();
    },
    handleBlur: function (e) {
      var inputEl = this.$.counter.querySelector('#userInput');
      if (inputEl && inputEl.contains(e.target)) return;
      // when blur
      if (this.showInput) this.updateValue();
    },
    ready: function () {
      window.addEventListener('mousedown', this.handleBlur.bind(this));
    },
    detached: function () {
      window.removeEventListener('mousedown', this.handleBlur.bind(this));
    }
  });
</script>

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/px-dropdown/px-dropdown.html">
<link rel="import" href="../bubble-radial-chart/bubble-radial-chart.html">
<link rel="import" href="device-status-chart-styles.html">
<link rel="import" href="../d3/d3.html">
<link rel="import" href="../behavior/context.html">

<dom-module id="device-status-chart">
  <template>
    <style include="device-status-chart-styles"></style>

    <!-- step chart -->
    <svg id="steps">
      <text class="legend-label"></text>
      <g class="legend"></g>
    </svg>

    <bubble-radial-chart id="chart"
       query-url="[[queryUrl]]"
       group-by="[['type']]"
       render-gauge="[[_renderGauge]]"
       on-opening-node-l1-changed="handleOpenNode"
       on-data-load="handleLoadData"
       gauge-radius-l1="[[_gaugeRadiusL1]]"
       gauge-radius-l2="[[_gaugeRadiusL2]]"
       transform-data="[[_transformData]]"
       bubble-config="[[_bubbleConfig]]">
    </bubble-radial-chart>
  </template>
  <script>
    define('device-status-chart', [
      'behavior/context',
    ], function(ContextBehavior) {
      var $ = d3.select;
      var gauge_color = d3.scaleOrdinal([
        'rgba(117, 162, 234, 1)',
        'rgba(140, 211, 199, 1)',
        'rgba(204, 185, 92, 1)',
        'rgba(187, 128, 188, 1)',
        'rgba(128, 177, 211, 1)',
        'rgba(184, 188, 128, 1)',
        'rgba(157, 155, 191, 1)',
        'rgba(152, 186, 145, 1)'
      ]);

      var gauge_fills = d3.scaleOrdinal([
        'rgb(210, 219, 235)',
        'rgb(215, 229, 227)',
        'rgb(228, 224, 204)',
        'rgb(224, 213, 225)',
        'rgb(213, 222, 229)',
        'rgb(224, 225, 213)',
        'rgb(218, 218, 225)',
        'rgb(217, 224, 216)'
      ]);

      var step_fills = d3.scaleOrdinal([
        'rgb(50, 97, 88)',
        'rgb(51, 57, 93)',
        'rgb(95, 52, 92)',
        'rgb(94, 95, 51)',
        'rgb(49, 90, 93)',
        'rgb(76, 95, 52)'
      ]);

      function wrap(text, width) {
        var words = text.text().split(/\s+/).reverse(),
          word,
          line = [],
          lineNumber = 0,
          lineHeight = 1.1, // ems
          y = text.attr("y") || 0,
          dy = parseFloat(text.attr("dy")) || 0,
          tspan = text.text(null).append("tspan").attr("x", 0).attr("y", y).attr("dy", dy + "em");

        while (word = words.pop()) {
          line.push(word);
          tspan.text(line.join(" "));
          if (tspan.node().getComputedTextLength() > width) {
            line.pop();
            tspan.text(line.join(" "));
            line = [word];
            tspan = text.append("tspan")
            .attr("x", 0)
            .attr("y", y)
            .attr("dy", ++lineNumber * lineHeight + dy + "em")
            .text(word);
          }
        }
      }

      function _transformItem(item) {
        if (!item.name) {
          item.name = item.display;
        }
        if (!(
            'revenue' in item
          )) {
          item.revenue = 'category' in item ? item.count : 1;
        }
        item['unit-label'] = '台';
        return item;
      }

      // http://browserhacks.com/#hack-2f32c95ac8c021c463de0fdf685acb29
      function isIE() {
        return window.navigator.msPointerEnabled;
      }

      Polymer({
        is: 'device-status-chart',
        properties: {
          steps: {
            type: Array,
          },
          category: {
            type: Number,
            value: null
          },
          queryUrl: {
            type: String,
            computed: '_computeQueryUrl(category)'
          },
          _gaugeRadiusL2: {
            value: function() {
              return {
                min: 80,
                max: 80
              };
            }
          },
          _gaugeRadiusL1: {
            value: function() {
              return {
                min: 70,
                max: 70
              };
            }
          }
        },
        behaviors: [
          ContextBehavior
        ],
        registered: function() {
          this.user = ContextBehavior.getUser();
        },
        observers: [
          'renderSteps(steps)'
        ],
        _computeQueryUrl: function(category) {
          var uri = URI(this.resolveApiUrl('/api/health'));
          if (typeof category === 'number') {
            uri.addQuery('category', category);
          } 
          if (this.user.isHead === 'false') { // this is insane...
            uri.addQuery('dept', this.user.orgId);
          }
          return uri.toString();
        },
        handleOpenNode: function(evt, data) {
          var node = data.value;
          if(node) {
            this.category = node.data.category;
          } else {
            this.steps = null;
          }
        },
        handleLoadData: function(evt, data) {
          this.steps = data.root.stages;
        },
        _createSteps: function(stageId) {
          return this.steps.map(function(step) {
            return {
              completed: step.id <= stageId
            };
          });
        },
        renderSteps: function(steps) {
          steps = steps || [];

          var canvas = $(this.$.steps);

          // legend
          var legend_label = canvas.select('.legend-label');

          // legend labels
          var labels = legend_label.selectAll('.step-label').data(steps);

          labels.enter()
          .append('tspan')
          .classed('step-label', 1)
          .merge(labels)
          .attr('fill', function(d, i) {
            return step_fills(i);
          })
          .attr('x', 0)
          .attr('dy', '1.2em')
          .text(function(d, i) {
            return ['S'+(i+1), ':', d.display, '（' + d.count + '）'].join(' ');
          });

          labels.exit().remove();

          var radius = legend_label.node().getBoundingClientRect().height / 2;
          legend_label.attr('transform', d3Transform().translate(radius * 2 + 10, 0))

          // legend donut
          var donut = d3.pie().value(function(d) { return d.count; });
          var arc = d3.arc()
          .innerRadius(radius - 20)
          .outerRadius(radius - 10)
          .padAngle(.05);

          // legend
          var legend = canvas.select('.legend')
          .attr('transform', d3Transform().translate(radius, radius));

          // arcs
          var arcs = legend.selectAll('.step').data(donut(steps));

          arcs.enter()
          .append('path')
          .classed('step', 1)
          .style('fill', function(d, i) {
            return step_fills(i);
          })
          .merge(arcs)
          .attr('d', arc);

          arcs.exit().remove();
        },
        ready: function() {
          var _this = this;

          this._renderGauge = function(element, node) {
            element = $(element);
            var textPixels = 50;
            var radius = node.circle.r;
            var size = radius * 2;

            var label;
            switch(node.orbitIndex) {

              // level 0 and level 1
              case 0:
              case 1:

                // display text
                element.append('text')
                .classed('node--text-label', 1)
                .text(node.data.display)
                .attr('text-anchor', 'middle')
                .attr('font-size', textPixels / 3 + 'px')
                .attr('fill', '#fff')
                .attr('transform', 'translate(' + [0, -.6 * radius].join(',') + ')')
                .call(wrap, size - 10);

                // count
                element.append('text')
                .classed('node--text-label', 1)
                .text(node.data.count)
                .attr('text-anchor', 'middle')
                .attr('font-size', textPixels + 'px')
                .attr('font-weight', 'bold')
                .attr('fill', '#fff')
                .attr('transform', 'translate(' + [0, .2 * radius].join(',') + ')');

                // unit
                element.append('text')
                .classed('node--text-label', 1)
                .text(node.data['unit-label'])
                .attr('text-anchor', 'middle')
                .attr('font-size', textPixels / 3 + 'px')
                .attr('fill', '#fff')
                .attr('transform', 'translate(' + [0, .6 * radius].join(',') + ')');
                break;

                // level 2
                case 2:
                  var category = node.parent.data.category;
                  switch(category) {

                    case 1:
                      // display text
                      var label = element.append('text')
                      .classed('node--text-label', 1)
                      .attr('text-anchor', 'left')
                      .attr('alignment-baseline', 'middle')
                      .attr('font-size', textPixels / 3 + 'px')
                      .attr('fill', '#fff');

                      // title
                      label.append('tspan')
                      .attr('x', 0)
                      .text(node.data.name);

                      // stage
                      label.append('tspan')
                      .attr('x', 0)
                      .attr('dy', '1.5em')
                      .text('维修流程：');
                      label.append('tspan')
                      .text(_this.steps.find(function(stg) {
                        return stg.id == node.data.stage
                      }).display);

                      // owner label
                      label.append('tspan')
                      .attr('x', 0)
                      .attr('dy', '1.5em')
                      .text('负责人：')
                      label.append('tspan')
                      .text(node.data.owner);

                      label.attr('transform', function() {
                        var rect = label.node().getBBox();
                        return d3Transform().translate(-rect.width / 2, -rect.height / 2)();
                      });

                      var steps = _this._createSteps(node.data.stage);
                      var outlineRadius = radius + 5;

                      // equally divided donut
                      var donut = d3.pie().value(function(d) { return 1; });
                      var arc = d3.arc()
                      .innerRadius(outlineRadius)
                      .outerRadius(outlineRadius + 10)
                      .padAngle(.05);

                      // stage status donut
                      var donutElement = element
                      .append('g')
                      .classed('steps', 1);

                      var arcs = donutElement.selectAll('.step')
                      .data(donut(steps))
                      .enter()
                      .append('path')
                      .classed('step', 1)
                      .style('fill', function(d, i) {
                        return d.data.completed ? step_fills(i) : 'transparent';
                      })
                      .attr('d', arc);

                      break;

                    // 保修期到期, 预防性维护，设备计量，设备质控
                    case 2:
                    case 3:
                    case 4:
                    case 5:
                    case 6:

                      // display text
                      label = element.append('text')
                      .classed('node--text-label', 1)
                      .attr('text-anchor', 'left')
                      .attr('alignment-baseline', 'middle')
                      .attr('font-size', textPixels / 3 + 'px')
                      .attr('fill', '#fff');

                      // title
                      label.append('tspan')
                      .attr('x', 0)
                      .text(node.data.name);

                      // date-time
                      label.append('tspan')
                      .attr('x', 0)
                      .attr('dy', '1.5em')
                      .text(node.data.date);

                      // description label
                      if (node.data.desc) {
                        label.append('tspan')
                        .attr('x', 0)
                        .attr('dy', '1.5em')
                        .text('原因：')
                        label.append('tspan')
                        .text(node.data.desc);
                      }

                      label.attr('transform', function() {
                        var rect = label.node().getBBox();
                        return d3Transform().translate(-rect.width / 2, -rect.height / 2)();
                      });
                      break;
                  }
            }
          };
          this._bubbleConfig = function(node, i, config) {
            var level = node.orbitIndex;

            var colorId = i;
            // use category as color index for level3 and above
            if (level > 1) {
              colorId = node.parent.data.category - 1;
            }

            config.height = config.width = node.size * 2;
            config.circleColor = gauge_color(colorId);
            config.fillColor = gauge_color(colorId);
            config.showWave = false;
            config.showLabel = false;
            config.waveAnimateTime = 5000;
            config.waveHeight = 0.15;
            config.waveOffset = 0.25;
            config.maxValue = +node.data.revenue_label;
            config.isRoot = node.depth;
            // gauge animation is way too expensive for IE
            config.waveRise = !isIE();
            config.waveAnimate = !isIE();
            config.valueCountUp = !isIE();
            return config;
          };

          this._transformData = function(data) {
            if (data.stages) {
              data.root.stages = data.stages;
            }

            data.root = _transformItem(data.root);
            data.items = data.items.map(_transformItem);

            return data;
          };
        }
      });
    });
  </script>
</dom-module>